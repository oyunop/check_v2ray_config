name: Subscription Checker 永不 canceled 终极版 + base64.txt

on:
  schedule:
    - cron: '0 8 * * *'      # 每天 UTC 8 点（北京时间 16 点）
  workflow_dispatch:

concurrency:
  group: subscription-checker
  cancel-in-progress: true

jobs:
  check-subscriptions:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout 本仓库（含 config）
        uses: actions/checkout@v4

      - name: 运行 beck-8/subs-check（强制生成 base64.txt + 优雅退出）
        run: |
          echo "开始运行 beck-8/subs-check，强制输出 base64.txt"
          docker run --rm \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/beck-8/subs-check:latest \

          # 给大文件留足同步时间（441KB+ 的 all.yaml 必须等）
          echo "等待卷同步完成..."
          sleep 10

          echo "=== output 目录最终内容 ==="
          ls -lah output/
          echo "base64.txt 共 $(wc -l < output/base64.txt 2>/dev/null || echo 0) 条链接"
          echo "all.yaml 大小 $(du -h output/all.yaml | cut -f1)"

      - name: Checkout 目标仓库
        uses: actions/checkout@v4
        with:
          repository: oyunop/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo
          clean: false

      - name: 复制所有文件并正常推送（去掉强制时间戳）
        run: |
          echo "开始复制最新文件到目标仓库"
          # 把 output 下所有文件都复制过去（包括 all.yaml、base64.txt、clash.yaml 等）
          cp -r output/* target-repo/ || echo "部分文件复制失败但继续"

          cd target-repo
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          git add .
          # 只有真的有变化才提交（干净、优雅、不刷提交记录）
          git diff --staged --quiet || \
            git commit -m "Auto update subscriptions $(date -u '+%Y-%m-%d %H:%M') UTC"

          git push
          echo "今日订阅（含 base64.txt）已成功推送！任务完美结束"
