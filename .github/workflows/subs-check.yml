name: Subscription Checker + Auto Kill Duplicates

on:
  schedule:
    - cron: '0 19 * * *'   # åŒ—äº¬æ—¶é—´ 3:00ï¼ˆUTC 19:00ï¼‰
  workflow_dispatch:

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…³é”®ï¼šè‡ªåŠ¨å–æ¶ˆæ­£åœ¨è¿è¡Œçš„æ—§ä»»åŠ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
concurrency:
  group: subscription-checker   # åŒä¸€ç»„åªèƒ½åŒæ—¶è·‘ä¸€ä¸ª
  cancel-in-progress: true      # æ–°ä»»åŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨ kill æ‰æ—§çš„æ­£åœ¨è¿è¡Œçš„

jobs:
  check-subscriptions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (æœ¬ä»“åº“)
        uses: actions/checkout@v4

      - name: æ˜¾ç¤ºå½“å‰ç›®å½•æ–‡ä»¶ï¼ˆè°ƒè¯•ç”¨ï¼Œå¯åˆ ï¼‰
        run: |
          echo "å½“å‰ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶:"
          ls -al

      - name: Run subscription checkerï¼ˆæ ¸å¿ƒï¼‰
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/jackrun123/subs-check:latest

      - name: Checkout ç›®æ ‡ä»“åº“ï¼ˆä½ è¦æ¨é€çš„ä»“åº“ï¼‰
        uses: actions/checkout@v4
        with:
          repository: oyunop/v2ray_configs   # â† æ”¹æˆä½ çš„ç›®æ ‡ä»“åº“
          token: ${{ secrets.PAT_TOKEN }}    # å¿…é¡»æ˜¯å¸¦ repo æƒé™çš„ PAT
          path: target-repo

      - name: å¤åˆ¶ç»“æœå¹¶æ¨é€åˆ°ç›®æ ‡ä»“åº“
        run: |
          # é˜²æ­¢ output ç›®å½•ä¸ºç©ºå¯¼è‡´ cp æŠ¥é”™
          if [ -z "$(ls -A output)" ]; then
            echo "output ç›®å½•ä¸ºç©ºï¼Œè·³è¿‡æ¨é€"
            exit 0
          fi
          
          cp -r output/* target-repo/ || echo "å¤åˆ¶å¤±è´¥ï¼Œä½†ä¸é˜»æ–­æµç¨‹"
          
          cd target-repo
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add *.txt *.yaml *.yml || echo "æ·»åŠ æ–‡ä»¶æ—¶å‡ºé”™"
          
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "ğŸ¤– Auto update subscriptions $(date '+%Y-%m-%d %H:%M:%S')" 
            git push
            echo "å·²æˆåŠŸæ¨é€æ›´æ–°ï¼"
          fi
