name: Subscription Checker + Auto Kill + Keep Schedule

on:
  schedule:
    - cron: '0 19 * * *'      # åŒ—äº¬æ—¶é—´æ¯å¤© 03:00 è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:         # æ”¯æŒæ‰‹åŠ¨ä¸€é”®è§¦å‘

# è‡ªåŠ¨å–æ¶ˆæ—§çš„é‡å¤è¿è¡Œï¼ˆé˜²æ­¢æ‰‹åŠ¨ç‹‚ç‚¹å¯¼è‡´å †ç§¯ï¼‰
concurrency:
  group: subscription-checker
  cancel-in-progress: true

jobs:
  check-subscriptions:
    runs-on: ubuntu-latest
    timeout-minutes: 40        # æ•´ä¸ªä»»åŠ¡æœ€å¤š40åˆ†é’Ÿï¼ŒGitHub ç»ˆæä¿é™©

    steps:
      - name: Checkout æœ¬ä»“åº“
        uses: actions/checkout@v4

      - name: Debugï¼šåˆ—å‡ºå½“å‰ç›®å½•æ–‡ä»¶
        run: ls -la

      - name: è¿è¡Œ subs-checkï¼ˆ30åˆ†é’Ÿå¿…æ€ï¼Œä¸‰ä¿é™©ï¼‰
        run: |
          # ç¬¬ä¸€ä¿é™©ï¼štimeout å¼ºæ€
          timeout --signal=KILL 1800 docker run --rm \
            -v ${{ github.workspace }}/config:/app/config \
            -v ${{ github.workspace }}/output:/app/output \
            ghcr.io/jackrun123/subs-check:latest \
            || echo "å®¹å™¨å·²è¶…æ—¶æˆ–å¼‚å¸¸ï¼Œè¢«å¼ºåˆ¶ç»ˆæ­¢ï¼ˆæ­£å¸¸ç°è±¡ï¼‰"

          # ç¬¬äºŒä¿é™©ï¼šæ¸…ç†å¯èƒ½æ®‹ç•™çš„åƒµå°¸å®¹å™¨
          docker ps -q --filter "ancestor=ghcr.io/jackrun123/subs-check" | xargs -r docker kill 2>/dev/null || true
          docker rm -f $(docker ps -aq --filter "ancestor=ghcr.io/jackrun123/subs-check" --filter "status=exited") 2>/dev/null || true

          # ç¬¬ä¸‰ä¿é™©ï¼šæ— è®ºå‰é¢æˆè´¥ï¼Œè¿™é‡Œå¼ºåˆ¶è®©æ­¥éª¤æˆåŠŸï¼Œç»§ç»­å¾€ä¸‹èµ°
          exit 0

      - name: Checkout ç›®æ ‡ä»“åº“ï¼ˆç”¨äºæ¨é€ï¼‰
        uses: actions/checkout@v4
        with:
          repository: oyunop/v2ray_configs
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo

      - name: å¤åˆ¶ç»“æœå¹¶æ¨é€åˆ°ç›®æ ‡ä»“åº“
        run: |
          # å¦‚æœ output ä¸ºç©ºå°±è·³è¿‡ï¼ˆé˜²æ­¢ç©ºæ¨é€ï¼‰
          [ -z "$(ls -A output 2>/dev/null)" ] && echo "output ä¸ºç©ºï¼Œè·³è¿‡æ¨é€" && exit 0

          cp -r output/* target-repo/ || echo "å¤åˆ¶å¤±è´¥ä½†ç»§ç»­"

          cd target-repo
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          git add *.txt *.yaml *.yml 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ¤– Auto update subscriptions $(date '+%Y-%m-%d %H:%M') (UTC)"
            git push
            echo "æˆåŠŸæ¨é€æ›´æ–°ï¼"
          fi
